{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2>{{ album.title }}</h2>

<div id="image-container">
  {% for image in images %}
    <div class="image-item" data-image-id="{{ image.id }}" data-is-selected="{{ image.isSelected }}">
      <img src="{{ image.imageLink }}" alt="Image">
      <div class="image-options">
        <label>
          <input type="checkbox" class="select-image" {% if image.isSelected %}checked{% endif %}>
          <span>Select</span>
        </label>
        <label>
          <input type="text" class="sheet-number" value="{{ image.sheetNumber|default_if_none:'' }}">
          <span>Sheet Number</span>
        </label>
        <label>
          <input type="text" class="position" value="{{ image.position|default_if_none:'' }}">
          <span>Position</span>
        </label>
        <label>
          <input type="text" class="priority" value="{{ image.priority|default_if_none:'' }}">
          <span>Priority</span>
        </label>
      </div>
    </div>
  {% endfor %}
</div>

<style>
   body {
  font-family: Arial, sans-serif;
}

h2 {
  font-size: 32px;
  margin-bottom: 20px;
}

#image-container {
  display: flex;
  flex-wrap: wrap;
}

.image-item {
  margin: 10px;
  position: relative;
  width: 150px;
  height: 150px;
}

.image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-options {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: rgba(0, 0, 0, 0.6);
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

.image-item:hover .image-options {
  opacity: 1;
}

.image-options label {
  font-size: 14px;
  color: #fff;
  margin-bottom: 5px;
}

.image-options input[type="text"] {
  width: 100%;
  padding: 5px;
  margin-bottom: 5px;
  border-radius: 5px;
  border: none;
}

.image-options input[type="checkbox"] {
  margin-right: 5px;
}

</style> 


 <script>
  const albumId = {{ album.id }};
  const socketUrl = `ws://${window.location.host}/ws/album/${albumId}/`;

  const imageContainer = document.getElementById('image-container');
  const imageItems = imageContainer.getElementsByClassName("image-item");

  // Connect to websocket
  const socket = new WebSocket(socketUrl);
  socket.addEventListener('open', function (event) {
    console.log('WebSocket connected!');
  });
  socket.onmessage = handleSocketMessage;

imageContainer.addEventListener("change", (event) => {
  const target = event.target;
  if (target.matches(".select-image, .sheet-number, .position, .priority")) {
    const imageItem = target.closest(".image-item");
    const imageId = imageItem.dataset.imageId;
    const isSelected = imageItem.dataset.isSelected;
    const sheetNumber = imageItem.querySelector(".sheet-number").value;
    const position = imageItem.querySelector(".position").value;
    const priority = imageItem.querySelector(".priority").value;
    const message = {
      image_id: imageId,
      is_selected: isSelected,
      sheet_number: sheetNumber,
      position: position,
      priority: priority
    };
    console.log(JSON.stringify(message));
    socket.send(JSON.stringify(message));
  }
});


  // Handle socket message
  function handleSocketMessage(event) {
    const data = JSON.parse(event.data);
    const imageId = data.image_id;
    const isSelected = data.is_selected;
    const sheetNumber = data.sheet_number;
    const position = data.position;
    const priority = data.priority;

    const imageItem = imageContainer.querySelector(`[data-image-id="${imageId}"]`);
    console.log(imageItem)
    imageItem.dataset.isSelected = isSelected;
    imageItem.querySelector('.select-image').checked = isSelected;
    imageItem.querySelector('.sheet-number').value = sheetNumber !== null ? sheetNumber : '';
    imageItem.querySelector('.position').value = position !== null ? position : '';
    imageItem.querySelector('.priority').value = priority !== null ? priority : '';
  }

   socket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
    };




</script> 

{% endblock %}
